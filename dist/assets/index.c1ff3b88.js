var n=Object.defineProperty,t=Object.defineProperties,e=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,a=(t,e,o)=>e in t?n(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,s=(n,t)=>{for(var e in t||(t={}))i.call(t,e)&&a(n,e,t[e]);if(o)for(var e of o(t))r.call(t,e)&&a(n,e,t[e]);return n},c=(n,o)=>t(n,e(o));"undefined"!=typeof require&&require;!function(){const n=document.createElement("link").relList;if(!(n&&n.supports&&n.supports("modulepreload"))){for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver((n=>{for(const e of n)if("childList"===e.type)for(const n of e.addedNodes)"LINK"===n.tagName&&"modulepreload"===n.rel&&t(n)})).observe(document,{childList:!0,subtree:!0})}function t(n){if(n.ep)return;n.ep=!0;const t=function(n){const t={};return n.integrity&&(t.integrity=n.integrity),n.referrerpolicy&&(t.referrerPolicy=n.referrerpolicy),"use-credentials"===n.crossorigin?t.credentials="include":"anonymous"===n.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(n);fetch(n.href,t)}}();var l=(n,t)=>{let e=0;return t.map((t=>{n[e++]=t.x,n[e++]=t.y,n[e++]=t.z})),n},m=(n=0,t=0,e=0)=>({x:n,y:t,z:e}),d=(n,t,e,o)=>(n.x=t,n.y=e,n.z=o,n),y=(n,t)=>(n.x=t,n.y=t,n.z=t,n),x=n=>m(n.x,n.y,n.z),v=(n,t)=>(n.x+=t.x,n.y+=t.y,n.z+=t.z,n),u=(n,t,e)=>(n.x+=t.x*e,n.y+=t.y*e,n.z+=t.z*e,n),p=(n,t)=>(n.x-=t.x,n.y-=t.y,n.z-=t.z,n),h=(n,t,e)=>(n.x=t.x-e.x,n.y=t.y-e.y,n.z=t.z-e.z,n),f=(n,t)=>(n.x*=t.x,n.y*=t.y,n.z*=t.z,n),g=(n,t)=>(n.x*=t,n.y*=t,n.z*=t,n),b=(n,t)=>{const{x:e,y:o,z:i}=n,r=1/(t[3]*e+t[7]*o+t[11]*i+t[15]);return n.x=(t[0]*e+t[4]*o+t[8]*i+t[12])*r,n.y=(t[1]*e+t[5]*o+t[9]*i+t[13])*r,n.z=(t[2]*e+t[6]*o+t[10]*i+t[14])*r,n},w=(n,t)=>{const{x:e,y:o,z:i}=n,r=t.x,a=t.y,s=t.z,c=t.w,l=c*e+a*i-s*o,m=c*o+s*e-r*i,d=c*i+r*o-a*e,y=-r*e-a*o-s*i;return n.x=l*c+y*-r+m*-s-d*-a,n.y=m*c+y*-a+d*-r-l*-s,n.z=d*c+y*-s+l*-a-m*-r,n},z=(n,t)=>g(n,1/t),M=(n,t)=>n.x*t.x+n.y*t.y+n.z*t.z,E=n=>Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z),j=n=>z(n,E(n)||1),R=(n,t)=>g(j(n),t),O=(n,t)=>{const{x:e,y:o,z:i}=n;return n.x=o*t.z-i*t.y,n.y=i*t.x-e*t.z,n.z=e*t.y-o*t.x,n},P=(n,t,e)=>{const o=t.x,i=t.y,r=t.z,a=e.x,s=e.y,c=e.z;return n.x=i*c-r*s,n.y=r*a-o*c,n.z=o*s-i*a,n},F=(n,t)=>Math.sqrt(A(n,t)),A=(n,t)=>{const e=n.x-t.x,o=n.y-t.y,i=n.z-t.z;return e*e+o*o+i*i},T=(n,t)=>(n.x=t[12],n.y=t[13],n.z=t[14],n),C=m(1,0,0),S=m(0,1,0),D=m(0,0,1),_=(n,t,e)=>{let o=M(n,t);return o<0?o*=e:o/=e,u(n,t,-o)};const L=m(),I=m(),W=m();var B=()=>new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),k=(n,t,e,o)=>(E(h(W,t,e))||(W.z=1),E(P(L,o,j(W)))||(1===Math.abs(o.z)?W.x+=1e-4:W.z+=1e-4,P(L,o,j(W))),P(I,W,j(L)),n[0]=L.x,n[4]=I.x,n[8]=W.x,n[1]=L.y,n[5]=I.y,n[9]=W.y,n[2]=L.z,n[6]=I.z,n[10]=W.z,n),U=(n,t,e)=>{const[o,i,r,a,s,c,l,m,d,y,x,v,u,p,h,f]=t,[g,b,w,z,M,E,j,R,O,P,F,A,T,C,S,D]=e;return n.set([o*g+s*b+d*w+u*z,i*g+c*b+y*w+p*z,r*g+l*b+x*w+h*z,a*g+m*b+v*w+f*z,o*M+s*E+d*j+u*R,i*M+c*E+y*j+p*R,r*M+l*E+x*j+h*R,a*M+m*E+v*j+f*R,o*O+s*P+d*F+u*A,i*O+c*P+y*F+p*A,r*O+l*P+x*F+h*A,a*O+m*P+v*F+f*A,o*T+s*C+d*S+u*D,i*T+c*C+y*S+p*D,r*T+l*C+x*S+h*D,a*T+m*C+v*S+f*D]),n},N=n=>{const[t,e,o,i,r,a,s,c,l,m,d,y,x,v,u,p]=n,h=m*u*c-v*d*c+v*s*y-a*u*y-m*s*p+a*d*p,f=x*d*c-l*u*c-x*s*y+r*u*y+l*s*p-r*d*p,g=l*v*c-x*m*c+x*a*y-r*v*y-l*a*p+r*m*p,b=x*m*s-l*v*s-x*a*d+r*v*d+l*a*u-r*m*u,w=t*h+e*f+o*g+i*b;if(0===w)return n.fill(0);const z=1/w;return n.set([h*z,(v*d*i-m*u*i-v*o*y+e*u*y+m*o*p-e*d*p)*z,(a*u*i-v*s*i+v*o*c-e*u*c-a*o*p+e*s*p)*z,(m*s*i-a*d*i-m*o*c+e*d*c+a*o*y-e*s*y)*z,f*z,(l*u*i-x*d*i+x*o*y-t*u*y-l*o*p+t*d*p)*z,(x*s*i-r*u*i-x*o*c+t*u*c+r*o*p-t*s*p)*z,(r*d*i-l*s*i+l*o*c-t*d*c-r*o*y+t*s*y)*z,g*z,(x*m*i-l*v*i-x*e*y+t*v*y+l*e*p-t*m*p)*z,(r*v*i-x*a*i+x*e*c-t*v*c-r*e*p+t*a*p)*z,(l*a*i-r*m*i-l*e*c+t*m*c+r*e*y-t*a*y)*z,b*z,(l*v*o-x*m*o+x*e*d-t*v*d-l*e*u+t*m*u)*z,(x*a*o-r*v*o-x*e*s+t*v*s+r*e*u-t*a*u)*z,(r*m*o-l*a*o+l*e*s-t*m*s-r*e*d+t*a*d)*z]),n},q=(n,t,e)=>Math.min(Math.max(n,t),e),V=(n,t)=>n+Math.random()*(t-n),H=n=>n*(.5-Math.random()),G=(n=0,t=0,e=0,o=1)=>({x:n,y:t,z:e,w:o}),X=(n,t)=>(n.x=t.x,n.y=t.y,n.z=t.z,n.w=t.w,n),K=(n,t)=>{const{x:e,y:o,z:i}=t,r=Math.cos(e/2),a=Math.cos(o/2),s=Math.cos(i/2),c=Math.sin(e/2),l=Math.sin(o/2),m=Math.sin(i/2);return n.x=c*a*s+r*l*m,n.y=r*l*s-c*a*m,n.z=r*a*m+c*l*s,n.w=r*a*s-c*l*m,n},Z=(n,t,e)=>{const o=e/2,i=Math.sin(o);return n.x=t.x*i,n.y=t.y*i,n.z=t.z*i,n.w=Math.cos(o),n},Y=(n,t)=>{const e=t[0],o=t[4],i=t[8],r=t[1],a=t[5],s=t[9],c=t[2],l=t[6],m=t[10],d=e+a+m;let y;return d>0?(y=.5/Math.sqrt(d+1),n.w=.25/y,n.x=(l-s)*y,n.y=(i-c)*y,n.z=(r-o)*y):e>a&&e>m?(y=2*Math.sqrt(1+e-a-m),n.w=(l-s)/y,n.x=.25*y,n.y=(o+r)/y,n.z=(i+c)/y):a>m?(y=2*Math.sqrt(1+a-e-m),n.w=(i-c)/y,n.x=(o+r)/y,n.y=.25*y,n.z=(s+l)/y):(y=2*Math.sqrt(1+m-e-a),n.w=(r-o)/y,n.x=(i+c)/y,n.y=(s+l)/y,n.z=.25*y),n},Q=(n,t,e)=>{const o=((n,t)=>2*Math.acos(Math.abs(q(J(n,t),-1,1))))(n,t);if(!o)return n;const i=Math.min(1,e/o);return tn(n,t,i),n},J=(n,t)=>n.x*t.x+n.y*t.y+n.z*t.z+n.w*t.w,$=n=>{let t=(n=>Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z+n.w*n.w))(n);return t?(t=1/t,n.x=n.x*t,n.y=n.y*t,n.z=n.z*t,n.w=n.w*t):(n.x=0,n.y=0,n.z=0,n.w=1),n},nn=(n,t)=>{const e=n.x,o=n.y,i=n.z,r=n.w,a=t.x,s=t.y,c=t.z,l=t.w;return n.x=e*l+r*a+o*c-i*s,n.y=o*l+r*s+i*a-e*c,n.z=i*l+r*c+e*s-o*a,n.w=r*l-e*a-o*s-i*c,n},tn=(n,t,e)=>{if(0===e)return n;if(1===e)return X(n,t);const{x:o,y:i,z:r,w:a}=n;let s=a*t.w+o*t.x+i*t.y+r*t.z;if(s<0?(n.w=-t.w,n.x=-t.x,n.y=-t.y,n.z=-t.z,s=-s):X(n,t),s>=1)return n.w=a,n.x=o,n.y=i,n.z=r,n;const c=1-s*s;if(c<=Number.EPSILON){const t=1-e;return n.w=t*a+e*n.w,n.x=t*o+e*n.x,n.y=t*i+e*n.y,n.z=t*r+e*n.z,$(n)}const l=Math.sqrt(c),m=Math.atan2(l,s),d=Math.sin((1-e)*m)/l,y=Math.sin(e*m)/l;return n.w=a*d+n.w*y,n.x=o*d+n.x*y,n.y=i*d+n.y*y,n.z=r*d+n.z*y,n};const en=G(),on=B();var rn=()=>({parent:void 0,children:[],components:[],position:m(),quaternion:G(),scale:m(1,1,1),matrix:B(),matrixWorld:B(),modelViewMatrix:B(),visible:!0,castShadow:!1,receiveShadow:!1}),an=(n,t)=>{Y(n.quaternion,k(on,t,n.position,S))},sn=(n,t)=>(t.parent=n,n.children.push(t),n),cn=(n,t)=>{const e=n.children.indexOf(t);e>=0&&n.children.splice(e,1)},ln=(n,t,e)=>(nn(n.quaternion,Z(en,t,e)),n),mn=(n,t)=>{t(n),n.children.map((n=>mn(n,t)))},dn=n=>{var t,e;(n=>{((n,t,e,o)=>{const{x:i,y:r,z:a,w:s}=e,c=i+i,l=r+r,m=a+a,d=i*c,y=i*l,x=i*m,v=r*l,u=r*m,p=a*m,h=s*c,f=s*l,g=s*m,b=o.x,w=o.y,z=o.z;n.set([(1-(v+p))*b,(y+g)*b,(x-f)*b,0,(y-g)*w,(1-(d+p))*w,(u+h)*w,0,(x+f)*z,(u-h)*z,(1-(d+v))*z,0,t.x,t.y,t.z,1])})(n.matrix,n.position,n.quaternion,n.scale)})(n),n.parent?U(n.matrixWorld,n.parent.matrixWorld,n.matrix):(t=n.matrixWorld,e=n.matrix,t.set(e)),n.children.map(dn)};const yn=Math.PI/180,xn=B();var vn=n=>{const{near:t,far:e}=n,o=t*Math.tan(.5*yn*n.fov),i=-o,r=i*n.aspect,a=o*n.aspect,s=2*t/(a-r),c=2*t/(o-i),l=(a+r)/(a-r),m=(o+i)/(o-i),d=-(e+t)/(e-t),y=-2*e*t/(e-t);n.projectionMatrix.set([s,0,0,0,0,c,0,0,l,m,d,-1,0,0,y,0])};const un=G(),pn=G();var hn=(n=-1,t=1,e=1,o=-1,i=.1,r=2e3)=>{const a=c(s({},rn()),{left:n,right:t,top:e,bottom:o,near:i,far:r,up:x(S),matrixWorldInverse:B(),projectionMatrix:B()});return fn(a),a},fn=n=>{const{left:t,right:e,top:o,bottom:i,near:r,far:a}=n,s=1/(e-t),c=1/(o-i),l=1/(a-r),m=(e+t)*s,d=(o+i)*c,y=(a+r)*l;n.projectionMatrix.set([2*s,0,0,0,0,2*c,0,0,0,0,-2*l,0,-m,-d,-y,1])};const gn=m();var bn=(n,t)=>{const{camera:e,matrix:o}=n;T(e.position,t.matrixWorld),((n,t)=>{Y(n.quaternion,k(xn,n.position,t,n.up))})(e,T(gn,t.target.matrixWorld)),(n=>{dn(n),n.matrixWorldInverse.set(n.matrixWorld),N(n.matrixWorldInverse)})(e),o.set([.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1]),U(o,U(o,o,e.projectionMatrix),e.matrixWorldInverse)},wn=(n,t)=>s({parent:void 0,update:n},t),zn=(n,t)=>(t.parent=n,n.components.push(t),n),Mn=(n,...t)=>n.components.map((n=>n.update(...t)));const En=m(),jn=m();var Rn=(n,t)=>{const e=F(n.position,t.position);return e<64?0:e<512?1:e<1024?2:3},On=(n,t)=>{const e=Rn(n,t);return 3!==e&&!!(1!==e&&2!==e||((n,t)=>M(j(h(jn,t.position,n.position)),w(Object.assign(En,D),n.quaternion))>.3)(n,t))};const Pn=new AudioContext,{sampleRate:Fn}=Pn,An=n=>2**((n-69)/12)*440,Tn=(n,t,e)=>{const o=t*Fn,i=new AudioBuffer({length:o,sampleRate:Fn}),r=i.getChannelData(0);for(let a=0;a<o;a++)r[a]=n(a/Fn,a,r)*e;return i},Cn=(n,t,e)=>new Proxy({},{get(o,i){const r=o[i]||Tn(n(An(i)),t,e);return o[i]=r,r}}),Sn=n=>t=>2*(t%(1/n)*n%1)-1,Dn=n=>t=>t%(1/n)*n%1>.5?1:-1,_n=()=>{let n=0;return()=>{const t=H(1),e=(n+.02*t)/1.02;return n=e,3.5*e}},Ln=(n,t)=>e=>{const o=n(e),i=t(e);return(n,t,e)=>o(n,t,e)*i(n,t,e)},In=(n,t,e)=>o=>(i,r,a)=>n(o+(i>e?t:0))(i,r,a),Wn=(n,t,e,o,i)=>{const r=n+t+e+o;return()=>e=>e<n?e/n:e<n+t?1-(e-n)/t*(1-i):e<r-o?i:e<r?(r-e)/o*i:0},Bn=new GainNode(Pn,{gain:.3}),kn=new GainNode(Pn,{gain:1-Bn.gain.value}),Un=new ConvolverNode(Pn),Nn=new GainNode(Pn);Nn.connect(kn).connect(Pn.destination),Nn.connect(Un).connect(Bn).connect(Pn.destination),(async()=>{const n=1.51,t=new OfflineAudioContext(1,n*Fn,Fn),e=new GainNode(t,{gain:0});e.gain.setValueAtTime(1,.01).exponentialRampToValueAtTime(.01,n);const o=new AudioBufferSourceNode(t,{buffer:Tn(_n(),n,1)});o.connect(e).connect(t.destination),o.start(),Un.buffer=await t.startRendering()})();const qn=n=>((n,t=Pn.destination)=>{const e=new AudioBufferSourceNode(Pn,{buffer:n});e.connect(t),e.start()})(n,Nn),Vn=Cn(Ln(Ln(Sn,_n),(Hn=24,()=>n=>Math.exp(-n*Hn))),.5,1);var Hn;const Gn=Cn(Ln(Ln(Dn,In(Dn,An(36)-An(31),.1)),Wn(.003,.05,.01,.03,.5)),.3,.2);const Xn=Cn(Ln(Ln(Sn,In(Dn,An(27)-An(15),.1)),Wn(.001,.3,.4,.3,.7)),1,.4);addEventListener("click",(()=>Pn.resume()),{once:!0});var Kn=(...n)=>t=>n.reduce(((n,t)=>t(n)),t),Zn=n=>(...t)=>e=>n(e,...t);const Yn=m();var Qn=(n,t)=>(n.vertices.map((n=>w(n,t))),n),Jn=(n,t,e,o)=>(d(Yn,t,e,o),n.vertices.map((n=>v(n,Yn))),n),$n=Zn(Jn),nt=Zn(((n,t)=>{const e=n.vertices.length;return n.vertices.push(...t.vertices.map(x)),n.faces.push(...t.faces.map((n=>{const t=(n=>({a:n.a,b:n.b,c:n.c,color:x(n.color),vertexColors:n.vertexColors.map(x)}))(n);return t.a+=e,t.b+=e,t.c+=e,t}))),n})),tt=(n,t,e)=>{const o=n/2,i=t/2,r=e/2;return((n,t,e)=>{const o=n.vertices.length;for(var i=0;i<t.length;)n.vertices.push(m(t[i++],t[i++],t[i++]));for(i=0;i<e.length;)n.faces.push((r=o+e[i++],a=o+e[i++],s=o+e[i++],{a:r,b:a,c:s,color:m(1,1,1),vertexColors:[]}));var r,a,s;return n})({vertices:[],faces:[]},[o,i,r,o,i,-r,o,-i,r,o,-i,-r,-o,i,-r,-o,i,r,-o,-i,-r,-o,-i,r],[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4])},et=[0],ot=[1],it=[2],rt=[4],at=[5],st=[7],ct=[0,1],lt=[2,3],mt=[4,5],dt=[6,7],yt=[0,2],xt=[1,3],vt=[4,6],ut=[5,7],pt=[0,5],ht=[1,4],ft=[2,7],gt=[0,1,2,3],bt=[4,5,6,7],wt=[0,1,4,5],zt=[2,3,6,7],Mt=[0,2,5,7],Et=[1,3,4,6],jt=[0,1,2,3,4,5,6,7],Rt=[0,1],Ot=[2,3],Pt=[4,5],Ft=[6,7],At=[8,9],Tt=[10,11];const Ct=m(),St=m(),Dt=m();var _t=(n,t,e)=>{Array.isArray(t)?d(n,...t):"object"==typeof t?Object.assign(n,e,t):"number"==typeof t&&y(n,t)};const Lt=(n,t,e)=>(y(e,0),t.map((t=>v(e,n.vertices[t]))),z(e,t.length),e);var It=Zn(((n,t)=>(Lt(n,t,Ct),Jn(n,-Ct.x,-Ct.y,-Ct.z)))),Wt=Zn(((n,t,e,o)=>(Lt(n,t,St),Lt(e,o,Dt),h(Ct,St,Dt),Jn(n,-Ct.x,-Ct.y,-Ct.z))));const Bt=(n,t=m())=>(e,...o)=>(o.map((([o,i])=>{_t(Ct,i,t),o.map((t=>n(e.vertices[t],Ct)))})),e);var kt=Zn(Bt(v)),Ut=Zn(Bt(f,m(1,1,1)));const Nt=((n,t=m())=>e=>(o,...i)=>(i.map((([i,r=t[e]])=>{Object.assign(Ct,t),Ct[e]=r,i.map((t=>n(o.vertices[t],Ct)))})),o))(v);var qt=Zn(Nt("x")),Vt=Zn(Nt("z")),Ht=(()=>{const n=m(),t=new Map([[gt,bt],[wt,zt],[Mt,Et],[bt,gt],[zt,wt],[Et,Mt]]);return(e,o,i)=>{_t(Ct,i,n);const r=t.get(o),a=tt();return o.map(((n,t)=>{const o=r[t];Object.assign(a.vertices[r===gt||r===bt?1^o:o],e.vertices[n]),v(Object.assign(a.vertices[n],e.vertices[n]),Ct)})),a}})(),Gt=Zn(((n,...t)=>(t.flat().sort(((n,t)=>n-t)).reverse().map((t=>n.faces.splice(t,1))),n))),Xt=m(0,-800,0);const Kt=new WeakMap;var Zt=(n,t,e)=>{const o=Kt.get(n)||{};return Kt.set(n,o),o[t]=o[t]||[],o[t].push(e),n},Yt=(n,t,e)=>{var o,i;return null==(i=null==(o=Kt.get(n))?void 0:o[t])||i.map((n=>n(e))),n},Qt=n=>{let t=0,e=n;return(o,i=!0)=>{if(e+=o,e-t>n)return i&&(t=e),i}},Jt=()=>({color:m(1,1,1),specular:m(1/15,1/15,1/15),shininess:30,emissive:m(),fog:!0}),$t=(n,t)=>c(s({},rn()),{geometry:n,material:t});const ne=m();var te=(n=m(1/0,1/0,1/0),t=m(-1/0,-1/0,-1/0))=>({min:n,max:t}),ee=(n,t)=>(Object.assign(n.min,t.min),Object.assign(n.max,t.max),n),oe=n=>n.max.x<n.min.x||n.max.y<n.min.y||n.max.z<n.min.z,ie=(n,t)=>{var e,o;return e=n.min,o=t,e.x=Math.min(e.x,o.x),e.y=Math.min(e.y,o.y),e.z=Math.min(e.z,o.z),((n,t)=>{n.x=Math.max(n.x,t.x),n.y=Math.max(n.y,t.y),n.z=Math.max(n.z,t.z)})(n.max,t),n},re=(n,t)=>((n=>{n.min.x=n.min.y=n.min.z=1/0,n.max.x=n.max.y=n.max.z-=1/0})(n),((n,t)=>{dn(t),mn(t,(t=>{var e;return null==(e=t.geometry)?void 0:e.vertices.map((e=>ie(n,b(Object.assign(ne,e),t.matrixWorld))))}))})(n,t),n),ae=(n,t)=>n.min.x<=t.x&&t.x<=n.max.x&&n.min.y<=t.y&&t.y<=n.max.y&&n.min.z<=t.z&&t.z<=n.max.z,se=(n,t)=>!(n.max.x<=t.min.x||n.min.x>=t.max.x||n.max.y<=t.min.y||n.min.y>=t.max.y||n.max.z<=t.min.z||n.min.z>=t.max.z),ce=(n,t)=>(v(n.min,t),v(n.max,t),n),le=Zn(((n,...t)=>(t.map((([t,e])=>{const o=m();_t(o,e),n.faces.map((n=>t.map((t=>((n,t,e)=>{n.a===t&&(n.vertexColors[0]=e),n.b===t&&(n.vertexColors[1]=e),n.c===t&&(n.vertexColors[2]=e)})(n,t,o)))))})),n))),me=Zn(((n,...t)=>(t.map((([t,e])=>t.map((t=>_t(n.faces[t].color,e))))),n)));const de=G(),ye=m();var xe=(n,...t)=>Kn(...t)(tt(...n)),ve=(...n)=>Kn(...n.map(nt))({vertices:[],faces:[]});const ue=tt(1,1,1),pe=Jt();y(pe.emissive,1);const he=Jt();y(he.color,0);var fe=(n,t)=>{const e=rn(),o=(i=n,r=m(),oe(i)?y(r,0):g((a=r,s=i.min,c=i.max,a.x=s.x+c.x,a.y=s.y+c.y,a.z=s.z+c.z,a),.5));var i,r,a,s,c;const l=((n,t)=>oe(n)?y(t,0):h(t,n.max,n.min))(n,m()),x=[...Array(t)].map((()=>{const n=$t(ue,pe);n.castShadow=!0,d(n.scale,V(4,l.x),V(4,2*l.y),V(4,l.z)),d(n.position,H(.5),H(.5),H(.5));const t=$t(ue,he);return d(t.scale,1-2/n.scale.x,1-2/n.scale.y,1-2/n.scale.z),n.scale.x*=-1,sn(n,t),v(f(n.position,l),o),sn(e,n),m(0,V(32,256),0)}));return zn(e,wn((n=>{let t=0;e.children.map(((e,o)=>{u(e.position,x[o],n),g(e.scale,1-5*n),E(e.scale)>.01&&t++})),t||cn(e.parent,e)})))};const ge=xe([.5,.5,1]),be=[[1,1,1],[1,.75,0],[1,.5,0]].map((n=>{const t=Jt();return d(t.color,...n),d(t.emissive,...n),t}));var we=n=>{const t=rn(),e=[...Array(n)].map((()=>{const n=$t(ge,(e=be)[Math.random()*e.length|0]);var e;n.castShadow=!0,y(n.scale,V(1,8)),d(n.position,H(4),H(4),H(4)),sn(t,n);const o=R(x(n.position),V(64,128));return an(n,o),o}));return zn(t,wn((n=>{let o=0;t.children.map(((t,i)=>{u(t.position,u(e[i],Xt,n),n),g(t.scale,1-8*n),E(t.scale)>.01&&o++})),o||cn(t.parent,t)})))},ze=(()=>{const n=m(),t=m(),e=B(),o=m();return(i,r,a)=>{let s=0;const c=i.faces.map((e=>{var o,r,a;return s+=(o=i.vertices[e.a],r=i.vertices[e.b],a=i.vertices[e.c],.5*E(O(h(n,a,r),h(t,o,r)))),s}));return ve(...[...Array(r)].map((()=>{const r=(n=>{let t=0,e=c.length-1;for(;t<=e;){const o=Math.ceil((t+e)/2);if(!o||c[o-1]<=n&&c[o]>n)return o;n<c[o]?e=o-1:t=o+1}return-1})(Math.random()*s),l=i.faces[r],m=i.vertices[l.a],d=i.vertices[l.b],x=i.vertices[l.c],v=((n,t,e)=>{let o=Math.random(),i=Math.random();o+i>1&&(o=1-o,i=1-i);const r=1-o-i;return u(u(u(y(ye,0),n,o),t,i),e,r)})(m,d,x),p=(f=m,j(O(h(n,x,g=d),h(t,f,g))));var f,g,w,z;w=k(e,o,p,S),z=v,w[12]=z.x,w[13]=z.y,w[14]=z.z;const M=a();return M.vertices.map((n=>b(n,e))),M})))}})(),Me=(n,t)=>zn(n,((n,t)=>{const e={physics:t,boundingBox:re(te(),n),velocity:m(),collide(){}};return wn((t=>u(n.position,e.velocity,t)),e)})(n,t)),Ee=n=>((n,t)=>n.components.find(t))(n,je),je=n=>n.physics,Re=n=>{const t=[];return mn(n,(n=>{var e,o;t.push(...(e=n,o=je,e.components.filter(o)))})),t};const Oe=(()=>{const n=m();return(t,e,o,i)=>{const r=i.max.x-o.min.x,a=o.max.x-i.min.x,s=i.max.y-o.min.y,c=o.max.y-i.min.y,l=i.max.z-o.min.z,m=o.max.z-i.min.z;let y=0;r>0&&a>0&&(y=r<a?r:-a);let x=0;s>0&&c>0&&(x=s<c?s:-c);let h=0;l>0&&m>0&&(h=l<m?l:-m);const f=Math.abs(y),b=Math.abs(x),w=Math.abs(h);f<b&&f<w?d(n,y,0,0):b<w?d(n,0,x,0):d(n,0,0,h);const z=t.parent,M=e.parent;1===t.physics?(u(M.position,n,-1.001),_(e.velocity,j(n),1.001)):1===e.physics?(u(z.position,n,1.001),_(t.velocity,j(n),1.001)):(g(n,.5),E(n)<1.001&&R(n,1.001),v(z.position,n),p(M.position,n))}})();var Pe=(()=>{const n=m(),t=m();return(e,o,i,r,a)=>{if(se(r,a))return e.allsolid=!0,void(e.fraction=0);y(n,1/0),h(t,i.velocity,o.velocity);const s=t.x,c=t.y,l=t.z,m=a.max.x-r.min.x,x=r.max.x-a.min.x,v=a.max.y-r.min.y,u=r.max.y-a.min.y,p=a.max.z-r.min.z,f=r.max.z-a.min.z;let g=0,b=1/0;if(s<0){if(m<0)return;m>0&&(b=Math.min(-m/s,b)),x<0&&(n.x=x/s,g=Math.max(n.x,g))}else if(s>0){if(x<0)return;x>0&&(b=Math.min(x/s,b)),m<0&&(n.x=-m/s,g=Math.max(n.x,g))}if(!(g>b)){if(c<0){if(v<0)return;v>0&&(b=Math.min(-v/c,b)),u<0&&(n.y=u/c,g=Math.max(n.y,g))}else if(c>0){if(u<0)return;u>0&&(b=Math.min(u/c,b)),v<0&&(n.y=-v/c,g=Math.max(n.y,g))}if(!(g>b)){if(l<0){if(p<0)return;p>0&&(b=Math.min(-p/l,b)),f<0&&(n.z=f/l,g=Math.max(n.z,g))}else if(l>0){if(f<0)return;f>0&&(b=Math.min(f/l,b)),p<0&&(n.z=-p/l,g=Math.max(n.z,g))}g>b||(e.fraction=g,n.x<n.y&&n.x<n.z?d(e.normal,Math.sign(s),0,0):n.y<n.z?d(e.normal,0,Math.sign(c),0):d(e.normal,0,0,Math.sign(l)))}}}})();const Fe=(n,t)=>ce(ee(n,t.boundingBox),t.parent.position);var Ae=(()=>{const n=te(),t=te(),e=te();return o=>{for(let a=0;a<o.length;a++){const s=o[a];for(let c=a+1;c<o.length;c++){const a=o[c];var i,r;if(1!==s.physics||1!==a.physics)if(4!==s.physics||4!==a.physics)if((4!==s.physics&&4!==a.physics||(4===s.physics?(i=s,r=a):(i=a,r=s),!ae(Fe(n,r),i.parent.position)||!1!==i.collide(r.parent)))&&se(Fe(t,s),Fe(e,a))){if(!1===s.collide(a.parent)||!1===a.collide(s.parent))continue;Yt(s.parent,"collide",a.parent),Yt(a.parent,"collide",s.parent),Oe(s,a,t,e)}}}}})();const Te=x(S);var Ce=()=>({allsolid:!1,fraction:1,endpos:m(),normal:m()});const Se=(n,t)=>(n.allsolid=t.allsolid,n.fraction=t.fraction,Object.assign(n.endpos,t.endpos),Object.assign(n.normal,t.normal),n),De=(()=>{const n=Ce();return t=>(Se(t,n),t)})();var _e=(()=>{const n=te(),t=te(),e=te(),o=m(),i=m(),r=Ce();return(a,s,c,l,m)=>{var d,y;De(c),Object.assign(o,s.velocity),Object.assign(s.velocity,h(i,m,l)),d=ce(ee(e,s.boundingBox),m),y=ce(ee(n,s.boundingBox),l),ie(ie(d,y.min),y.max);for(let o=0;o<a.length;o++){const i=a[o];se(e,ce(ee(t,i.boundingBox),i.parent.position))&&(Pe(De(r),s,i,n,t),r.fraction<c.fraction&&Se(c,r))}Object.assign(s.velocity,o),((n,t,e,o)=>{v(g(h(n,e,t),o),t)})(c.endpos,l,m,c.fraction)}})();const Le=(n,t,e,o)=>{const i=Re(n.scene).filter((t=>t!==n.body&&4!==t.physics));_e(i,n.body,t,e,o)},Ie=(()=>{const n=m();let t;const e=[...Array(5)].map((()=>m())),o=m(),i=Ce(),r=m(),a=m(),s=m();return(c,l)=>{l&&(Object.assign(a,c.body.velocity),a.y-=c.gravity*c.dt,c.body.velocity.y=.5*(c.body.velocity.y+a.y),c.walking&&_(c.body.velocity,Te,1.001));let m,d=c.dt;c.walking?(t=1,Object.assign(e[0],Te)):t=0,j(Object.assign(e[t],c.body.velocity)),t++;for(m=0;m<4;m++){if(u(Object.assign(r,c.object.position),c.body.velocity,d),Le(c,i,c.object.position,r),i.allsolid)return c.body.velocity.y=0,!0;if(i.fraction>0&&Object.assign(c.object.position,i.endpos),1===i.fraction)break;if(d-=d*i.fraction,t>=5)return y(c.body.velocity,0),!0;for(var x=0;x<t;x++)if(M(i.normal,e[x])>.99){v(c.body.velocity,i.normal);break}if(!(x<t))for(Object.assign(e[t],i.normal),t++,x=0;x<t;x++){if(!(M(c.body.velocity,e[x])>=.1)){_(Object.assign(o,c.body.velocity),e[x],1.001),l&&_(Object.assign(s,a),e[x],1.001);for(let i=0;i<t;i++)if(i!==x&&!(M(o,e[i])>=.1||(_(o,e[i],1.001),l&&_(s,e[i],1.001),M(o,e[x])>=0))){g(Object.assign(o,j(P(n,e[x],e[i]))),M(n,c.body.velocity)),l&&g(Object.assign(s,n),M(n,a));for(let n=0;n<t;n++)if(n!==x&&n!==i&&!(M(o,e[n])>=.1))return y(c.body.velocity,0),!0}Object.assign(c.body.velocity,o),l&&Object.assign(a,s);break}}}return l&&Object.assign(c.body.velocity,a),0!==m}})(),We=n=>!(n.command.y<10)&&(n.jump?(n.command.y=0,!1):(n.walking=!1,n.jump=!0,n.body.velocity.y=270,qn(Gn[31]),!0));var Be=(()=>{const n=m(),t=m();return e=>{if(We(e))return void ke(e);Ue(e);const o=e.command.z,i=e.command.x,r=Ne(e);e.viewForward.y=0,e.viewRight.y=0,u(u(y(n,0),j(_(e.viewForward,Te,1.001)),o),j(_(e.viewRight,Te,1.001)),i);let a=E(Object.assign(t,n));j(t),a*=r,qe(e,t,a,10),_(e.body.velocity,Te,1.001),(e.body.velocity.x||e.body.velocity.z)&&Ie(e,!1)}})(),ke=(()=>{const n=m(),t=m();return e=>{Ue(e);const o=e.command.z,i=e.command.x,r=Ne(e);e.viewForward.y=0,e.viewRight.y=0,u(u(y(n,0),j(e.viewForward),o),j(e.viewRight),i),n.y=0,Object.assign(t,n);let a=E(t);j(t),a*=r,qe(e,t,a,1),e.walking&&_(e.body.velocity,Te,1.001),Ie(e,!0)}})(),Ue=(()=>{const n=m();return t=>{const e=t.body.velocity;Object.assign(n,e),t.walking&&(n.y=0);const o=E(n);if(o<1)return e.x=0,void(e.z=0);let i=0;if(t.walking){i+=6*(o<100?100:o)*t.dt}let r=o-i;r<0&&(r=0),r/=o,g(e,r)}})(),Ne=n=>{const t=Math.max(Math.abs(n.command.x),Math.abs(n.command.y),Math.abs(n.command.z));if(!t)return 0;const e=E(n.command);return n.speed*t/(127*e)},qe=(n,t,e,o)=>{const i=e-M(n.body.velocity,t);if(i<=0)return;let r=o*n.dt*e;r>i&&(r=i),u(n.body.velocity,t,r)},Ve=(()=>{const n=m(),t=Ce();return e=>{Object.assign(n,e.object.position),n.y-=.25,Le(e,t,e.object.position,n),1!==t.fraction?e.walking=!0:e.walking=!1}})();const He=(()=>{const n={};return addEventListener("keydown",(t=>n[t.code]=!0)),addEventListener("keyup",(t=>n[t.code]=!1)),n})();let Ge=!1;const Xe=G(),Ke=m(),Ze=m();var Ye=(n,t,e)=>{const o=n.createProgram(),i=(t,e)=>{const i=n.createShader(t);n.shaderSource(i,e),n.compileShader(i),n.attachShader(o,i)};return i(n.VERTEX_SHADER,t),i(n.FRAGMENT_SHADER,e),n.linkProgram(o),o},Qe=(n,t,e)=>n.uniformMatrix4fv(t,!1,e),Je=(n,t,e)=>n.uniform3f(t,e.x,e.y,e.z),$e=(n,t)=>{const e={},o=n.getProgramParameter(t,n.ACTIVE_ATTRIBUTES);for(let i=0;i<o;i++){const o=n.getActiveAttrib(t,i),{name:r}=o;e[r]=n.getAttribLocation(t,r)}return e},no=(n,t)=>{const e={},o=n.getProgramParameter(t,n.ACTIVE_UNIFORMS);for(let i=0;i<o;i++){const o=n.getActiveUniform(t,i),{name:r}=o;e[r]=n.getUniformLocation(t,r)}return e},to="\n#version 300 es\n\nprecision highp float;\nprecision highp int;\n\nvec4 packDepthToRGBA(float v) {\n  vec4 r = vec4(\n    fract(\n      v *\n      // PackFactors\n      vec3(256 * 256 * 256, 256 * 256, 256)\n    ),\n    v\n  );\n  r.yzw -=\n    r.xyz *\n    // ShiftRight8\n    1. / 256.;\n  return\n    r *\n    // PackUpscale\n    256. / 255.;\n}\n\nin vec2 vHighPrecisionZW;\n\nout vec4 color;\n\nvoid main() {\n  color = packDepthToRGBA(\n    // fragCoordZ\n    .5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + .5\n  );\n}\n".trim(),eo="\n#version 300 es\n\nprecision highp float;\nprecision highp int;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nin vec3 position;\n\nout vec2 vHighPrecisionZW;\n\nvoid main() {\n  gl_Position =\n    projectionMatrix *\n    // mvPosition\n    modelViewMatrix * vec4(position, 1);\n  vHighPrecisionZW = gl_Position.zw;\n}\n".trim(),oo="\n#version 300 es\n\nprecision highp float;\nprecision highp int;\n\n#define saturate(a) clamp(a, 0., 1.)\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\n\nin vec3 vColor;\n\nuniform bool fog;\nuniform vec3 fogColor;\nin vec3 vFogPosition;\nuniform float fogNear;\nuniform float fogFar;\n\nuniform bool receiveShadow;\nuniform vec3 ambient;\n\nstruct DirectionalLight {\n  vec3 direction;\n  vec3 color;\n};\n\nuniform DirectionalLight directionalLight;\n\nin vec3 vViewPosition;\n\nuniform sampler2D directionalShadowMap;\nin vec4 vDirectionalShadowCoord;\n\nout vec4 color;\n\nvoid main() {\n  vec3 diffuseColor = diffuse * vColor;\n\n  vec3 normal = normalize(cross(dFdx(vViewPosition), dFdy(vViewPosition)));\n  vec3 viewDir = normalize(vViewPosition);\n\n  vec4 shadowCoord = vDirectionalShadowCoord;\n  shadowCoord.xyz /= shadowCoord.w;\n  vec3 irradiance =\n    // dotNL\n    saturate(dot(normal, directionalLight.direction)) *\n    directionalLight.color *\n    // getShadow\n    (receiveShadow &&\n    all(\n      bvec2(\n        all(\n          bvec4(\n            shadowCoord.x >= 0.,\n            shadowCoord.x <= 1.,\n            shadowCoord.y >= 0.,\n            shadowCoord.y <= 1.\n          )\n        ),\n        shadowCoord.z <= 1.\n      )\n    )\n      ? // texture2DCompare\n        step(\n          shadowCoord.z,\n          // unpackRGBAToDepth\n          dot(\n            texture(directionalShadowMap, shadowCoord.xy),\n            // UnpackFactors\n            // UnpackDownscale\n            255. / 256. /\n            // PackFactors\n            vec4(256 * 256 * 256, 256 * 256, 256, 1.)\n          )\n        )\n      : 1.);\n  vec3 halfDir = normalize(directionalLight.direction + viewDir);\n  float dotVH = saturate(dot(viewDir, halfDir));\n  float fresnel = exp2((-5.55473 * dotVH - 6.98316) * dotVH);\n\n  color = vec4(\n    mix(\n      // outgoingLight\n      // directDiffuse\n      irradiance * diffuseColor +\n      // indirectDiffuse\n      ambient * diffuseColor +\n      // directSpecular\n      irradiance *\n        // F_Schlick\n        (specular * (1. - fresnel) + fresnel) *\n        // G_BlinnPhong_Implicit\n        .25 *\n        // D_BlinnPhong\n        (shininess * .5 + 1.) *\n        pow(\n          // dotNH\n          saturate(dot(normal, halfDir)),\n          shininess\n       ) +\n      emissive,\n      fogColor,\n      // fogFactor\n      fog\n        ? smoothstep(\n            fogNear,\n            fogFar,\n            // fogDepth\n            length(vFogPosition)\n          )\n        : 0.\n    ),\n    1\n  );\n}\n".trim(),io="\n#version 300 es\n\nprecision highp float;\nprecision highp int;\n\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nin vec3 position;\nout vec3 vViewPosition;\n\nin vec3 color;\nout vec3 vColor;\n\nout vec3 vFogPosition;\n\nuniform mat4 directionalShadowMatrix;\nout vec4 vDirectionalShadowCoord;\n\nvoid main() {\n  vColor.xyz = color.xyz;\n\n  vec4 mvPosition = modelViewMatrix * vec4(position, 1);\n\n  gl_Position = projectionMatrix * mvPosition;\n  vViewPosition = -mvPosition.xyz;\n\n  vDirectionalShadowCoord =\n    directionalShadowMatrix *\n    // worldPosition\n    modelMatrix * vec4(position, 1);\n\n  vFogPosition = mvPosition.xyz;\n}\n".trim();const ro=canvas.getContext("webgl2");ro.clearColor(0,0,0,0),ro.enable(ro.DEPTH_TEST),ro.enable(ro.CULL_FACE),ro.depthFunc(ro.LEQUAL);let ao=!1;const so=rn();so.fogColor=m(),so.fogNear=1,so.fogFar=1e3;const co=((n=60,t=1,e=.1,o=2e3)=>{const i=c(s({},rn()),{fov:n,near:e,far:o,aspect:t,up:x(S),matrixWorldInverse:B(),projectionMatrix:B()});return vn(i),i})(90);var lo,mo;lo=(n=>{const t=m(),e=m();var o={object:n,sensitivity:.002,enabled:!1,onMouseMove(i){o.enabled&&(t.x=q(t.x-i.movementY*o.sensitivity,-Math.PI/2,Math.PI/2),e.y-=i.movementX*o.sensitivity,Object.assign(n.quaternion,nn(K(pn,e),K(un,t))))}};return addEventListener("mousemove",o.onMouseMove),o})(co),mo=canvas,document.addEventListener("pointerlockchange",(()=>lo.enabled=mo===document.pointerLockElement)),addEventListener("click",(()=>mo.requestPointerLock()));const{ambient:yo,directional:xo}=((n,t,e)=>{const o=rn();sn(t,o);const i=m(.2,.2,.3),r=((n=m(),t=1)=>c(s({},rn()),{color:n,intensity:t,target:rn(),shadow:{camera:hn(-5,5,5,-5,.5,500),matrix:B()}}))(m(1,1,1));d(r.position,64,256,-64),sn(o,r),e.far=16384;const a=rn();sn(a,e),sn(o,a);const l=Me($t(tt(30,56,30),Jt()),2);l.position.y+=28,l.visible=!1,Object.assign(a.position,l.position),sn(o,l);const x=Ee(l);x.update=()=>{};const p={object:l,body:x,scene:void 0,command:m(),dt:0,gravity:800,speed:320,viewForward:m(),viewRight:m(),jump:0,walking:!1};p.scene=o;let f=100,z=0;const P=()=>{const n=512,t=b(Object.assign(Ke,a.position),r.shadow.camera.matrixWorldInverse);Object.assign(r.shadow.camera,{left:t.x-n,right:t.x+n,top:t.y+n,bottom:t.y-n}),fn(r.shadow.camera)};dn(r),bn(r.shadow,r),P();const A=n=>{const t=Jt();d(t.color,.7,.7,.75);const e=Me($t(n,t),1);return e.castShadow=!0,e.receiveShadow=!0,sn(o,e),e};[[[160,128,256],[-512,0,128],[It(dt)]]].map((([n,t,e=[It(zt)]])=>d(A(xe(n,...e)).position,...t))),[[[1024,16,768,8],[0,0,0]],[[128,8,256,8],[256,48,-240]],[[128,8,172,8],[-256,16,-192]],[[160,8,246,8],[128,160,0]],[[512,8,352,8],[0,32,-544]],[[128,8,128,8],[256,64,0]],[[128,8,160,8],[320,96,144]],[[480,8,128,8],[0,128,256]],[[128,24,128,8],[-160,12,0]],[[128,24,128,8],[-160,96,0]]].map((([n,t])=>d(A(((n,t,e,o)=>{const i=n-4*o,r=e-4*o,a=Gt(Rt,Ot,At,Tt),s=xe([n-2*o,t,r],a),c=xe([i,t,o],Wt(Et,s,Mt),qt([vt,-o],[xt,o]),a),l=xe([i,t,o],Wt(Mt,s,Et),qt([ut,-o],[yt,o]),a),m=[o,t,o],d=le([jt,[.4,.4,.5]]),y=o/2;return ve(s,c,l,xe([i,t,o],Wt(Et,c,Mt),qt([ut,-y],[yt,y]),Gt(Rt,Ot,Tt),d),xe([i,t,o],Wt(Mt,l,Et),qt([vt,-y],[xt,y]),Gt(Rt,Ot,At),d),xe([o,t,r],Wt(bt,s,gt),Vt([xt,-y],[yt,y]),Gt(Ot,At,Tt),d),xe([o,t,r],Wt(gt,s,bt),Vt([vt,-y],[ut,y]),Gt(Rt,At,Tt),d),xe(m,Wt(vt,s,yt),kt([gt,{z:y}],[Mt,{x:-o}],[yt,{x:-y,z:y}]),d),xe(m,Wt(xt,s,ut),kt([bt,{z:y}],[Mt,{x:o}],[ut,{x:y,z:y}]),d),xe(m,Wt(ut,s,xt),kt([gt,{z:-y}],[Et,{x:-o}],[xt,{x:-y,z:-y}]),d),xe(m,Wt(yt,s,vt),kt([bt,{z:-y}],[Et,{x:o}],[vt,{x:y,z:-y}]),d))})(...n)).position,...t))),[].map((([n,t,e,o])=>A(((n,t,e,o)=>{h(ye,t,n);const i=ye.x,r=ye.z;return xe(i?[i,o,e]:[e,o,r],It(i?mt:ht),$n(n.x,n.y,n.z))})(m(...n),m(...t),e,o)))),((n,t,e)=>{const o=(t-n)/(e+1);return[...Array(e)].map(((t,e)=>n+o*(e+1)))})(256,0,4).map((n=>[-340,0,n])).map((n=>d(A(((n,t,e=n)=>{const o=xe([e,3/16*t,n],It(zt)),i=Kn((()=>Ht(o,wt,{y:3/4*t})),qt([ct,-e/2]),Gt(Ft))(),r=Kn((()=>Ht(i,wt,{y:1/16*t})),qt([ct,-e/2]),Gt(Ft))();return ve(o,i,r)})(24,128)).position,...n)));const T=Jt();y(T.emissive,1),T.fog=!1,sn(a,$t(((n,t)=>{const e=[];for(let o=0;o<t;o++){const t=2*Math.PI*Math.random(),o=2*Math.random()-1,i=Math.sqrt(1-o*o),r=V(8,32);e.push(xe([r,r,r],$n(n*i*Math.cos(t),n*i*Math.sin(t),n*o)))}return ve(...e)})(15360,512),T));const _=Jt();y(_.specular,1),_.fog=!1;const L=$t((()=>{const n=12288,t=1280,e=128,o=512,i=5/6*t,r=xe([t,e,n],It(gt),qt([ut,i],[jt,-256]),kt([ft,{y:e}]),Gt(Pt)),a=Kn((()=>Ht(r,wt,{y:o})),kt([vt,{x:i}],[pt,{y:-512}]),Gt(Ot,Ft))(),s=Kn((()=>Ht(a,bt,{x:-i})),kt([ut,{x:i}],[rt,{y:-512}]),Gt(Rt,Ft))(),c=xe([t,e,n],It(bt),qt([yt,-i],[jt,256]),kt([ft,{y:e}]),Gt(Pt)),l=Kn((()=>Ht(c,wt,{y:o})),kt([xt,{x:-i}],[pt,{y:-512}]),Gt(Rt,Ft))(),m=Kn((()=>Ht(l,gt,{x:i})),kt([yt,{x:-i}],[ot,{y:-512}]),Gt(Ot,Ft))(),d=ve(r,a,s,c,l,m,xe([768,384,3072],It(ft),kt([jt,{z:-4096}],[ht,{y:-128}])));return ve(d,ze(d,2048,(()=>xe([V(16,128),V(16,128),V(16,64)],It(Mt)))))})(),_);var I,W;d(L.position,512,1536,-6144),I=L,W=-Math.PI/2,ln(I,S,W),((n,t)=>{ln(n,C,t)})(L,-Math.PI/8),((n,t)=>{ln(n,D,t)})(L,-Math.PI/4),sn(o,L);const k=()=>{const n=Jt(),t=$t((()=>{const n=40,t=16,e=m(16,1,1),o=xe([n,12,t],It(zt),kt([jt,{y:60}],[ct,{x:-20}],[mt,{x:20}],[pt,{z:-16}],[it,{x:-20}],[st,{x:20}],[ft,{y:-8}])),i=xe([18,56,t],It(lt),kt([jt,{x:-2}],[dt,{x:18}],[ct,{y:-8}],[ft,{z:-16}],[at,{z:-16}])),r=xe([18,56,t],It(dt),kt([jt,{x:2}],[lt,{x:-18}],[mt,{y:-8}],[ft,{z:-16}],[et,{z:-16}])),a=xe([8,8,8],(n=>Qn(n,K(de,d(ye,Math.PI/4,-Math.PI/4,0)))),me([Rt,e],[Pt,e],[At,e]),$n(0,54,-4));return ve(o,i,r,a)})(),n);return y(n.color,.5),y(n.specular,1),t.castShadow=!0,t.receiveShadow=!0,t},U=(n,t)=>{let e,i=t;const r=Ee(n);return Zt(n,"collide",(t=>{if(4===Ee(t).physics)if(i--,clearTimeout(e),i<=0){qn(Xn[15]),J(n.position);const t=fe(r.boundingBox,16);Object.assign(t.position,n.position),Object.assign(t.quaternion,n.quaternion),sn(o,t),cn(o,n)}else n.material.emissive.x=1,e=setTimeout((()=>n.material.emissive.x=0),48)})),n},N=(n,t)=>{let e=0;return zn(n,wn((o=>{e+=o,e>t&&cn(n.parent,n)})))},G=()=>{const n=Jt();y(n.color,.5),y(n.specular,1);const t=$t((()=>{const n=m(16,1,1),t=xe([16,16,6],Ut([Mt,{x:.5,y:.5}]),me([At,n]),Gt(Tt));return Qn(ve(t,xe([16,16,26],Wt(Mt,t,Et),Ut([Et,{x:0,y:0}]),Gt(At))),K(de,d(ye,0,0,Math.PI/4)))})(),n);return t.castShadow=!0,t.receiveShadow=!0,t},X=()=>{const n=tt(2,2,8),t=Jt();d(t.emissive,2,.5,.5);const e=N(Me($t(n,t),4));return e.castShadow=!0,e},Y=(n=2)=>{f-=n,f<=0&&(document.exitPointerLock(),document.querySelector(".e").hidden=!1)};var J=n=>{const t=we(4);Object.assign(t.position,n),sn(o,t)};const $=Qt(.1);let nn,tn;const en=Qt(7),on=Qt(3);return zn(o,wn((n=>{nn=Re(o),tn=nn.filter((n=>1===n.physics)),tn.map((n=>n.parent)),Ae(nn),p.dt=n,y(p.command,0),(He.KeyW||He.ArrowUp)&&p.command.z++,(He.KeyS||He.ArrowDown)&&p.command.z--,(He.KeyA||He.ArrowLeft)&&p.command.x--,(He.KeyD||He.ArrowRight)&&p.command.x++,He.Space&&p.command.y++;if(g(p.command,127),d(p.viewForward,0,0,-1),d(p.viewRight,1,0,0),w(d(p.viewForward,0,0,-1),e.quaternion),j(O(d(p.viewRight,0,-1,0),p.viewForward)),(n=>{n.command.y<10&&(n.jump=!1),Ve(n),n.walking?Be(n):ke(n),Ve(n)})(p),Object.assign(a.position,l.position),P(),f=q(f+1*n,0,100),document.querySelector(".h").textContent=Math.round(f),document.querySelector(".s").textContent=z,l.position.y<=-2048&&Y(100),$(n,Ge)){qn(Vn[16]);const n=tt(2,2,8),t=Jt();d(t.emissive,.5,.5,2);const i=N(Me($t(n,t),4),4);i.castShadow=!0,an(i,u(d(Ke,H(1),H(1),H(1)),w(Object.assign(Ze,D),e.quaternion),-16));const r=Ee(i);u(r.velocity,w(Object.assign(Ke,D),i.quaternion),800),v(w(d(i.position,7.5,-7,0),e.quaternion),l.position),sn(o,i),r.collide=n=>{if(n===l)return!1;J(i.position),cn(o,i),n.isPhantom&&(z+=100),n.isScanner&&(z+=50)}}if(en(n)){const n=(()=>{let n=0;const t=m(),e=m(),i=Ce(),r=Qt(1.1);var a=zn(U(Me(k(),2),5),wn((s=>{0===n&&On(a,l);const c=Ee(a);u(c.velocity,Xt,s);const m=Rn(a,l),d=2===n||On(a,l)?h(Ke,l.position,a.position):y(Ke,0);if(d.y=0,j(d),E(d)&&(Z(Xe,S,Math.atan2(d.x,d.z)),Q(a.quaternion,Xe,Math.PI*s),R(Object.assign(Ze,d),160),Object.assign(t,a.position),u(Object.assign(e,t),Ze,16*s),Object.assign(t,e),e.y-=.25,_e(tn,c,i,t,e),i.allsolid),0!==m){const n=c.velocity.y;c.velocity.y=0;const t=E(c.velocity),e=Math.max(t,100),o=Math.max(t-6*e*s,0);R(c.velocity,o);const i=M(c.velocity,d);c.velocity.y=n;const r=160-i;if(r>0){const n=Math.min(10*s*160,r);u(c.velocity,d,n)}}const x=Object.assign(Ze,a.position);if(x.y+=52,r(s,On(a,l))){const n=X();Object.assign(n.position,x),an(n,l.position);const t=Ee(n);g(w(Object.assign(t.velocity,D),n.quaternion),400),sn(o,n),t.collide=t=>{if(t.isEnemy)return!1;t===l&&Y(),J(n.position),cn(o,n)}}})));return a.isEnemy=!0,a.isPhantom=!0,Zt(a,"collide",(t=>{4===Ee(t).physics&&(n=2)})),a})();d(n.position,V(-160,150),V(128,32),V(-512,-640)),sn(o,n)}if(on(n)){const n=(()=>{let n=0;const t=m(),e=m(),i=m(),r=Ce(),a=Qt(1.3),s=V(64,128);var c=zn(U(Me(G(),2),2),wn((m=>{0===n&&On(c,l)&&(n=2);const d=Ee(c);g(Object.assign(t,d.velocity),-.5);const x=Rn(c,l),p=2===n||On(c,l)?h(Ke,l.position,c.position):y(Ke,0);j(p),E(p)&&(Z(Xe,S,Math.atan2(p.x,p.z)),Q(c.quaternion,Xe,Math.PI*m),R(Object.assign(Ze,p),400));const f=d.velocity.y;if(f<=32&&(Object.assign(e,c.position),Object.assign(i,e),i.y-=32,_e(tn,d,r,e,i),1!==r.fraction)){const n=Math.max(16,.5*-f);t.y+=n*(1-r.fraction)}if(0!==x&&F(c.position,l.position)>s){const n=E(d.velocity),t=Math.max(n,20),e=Math.max(n-.3*t*m,0);R(d.velocity,e);const o=400-M(d.velocity,p);if(o>0){const n=Math.min(10*m*400,o);u(d.velocity,p,n)}}const b=Object.assign(Ze,c.position);if(a(m,On(c,l))){const n=X();Object.assign(n.position,b),an(n,l.position);const t=Ee(n);g(w(Object.assign(t.velocity,D),n.quaternion),400),sn(o,n),t.collide=t=>{if(t.isEnemy)return!1;t===l&&Y(),J(n.position),cn(o,n)}}v(d.velocity,t)})));return c.isEnemy=!0,c.isScanner=!0,Zt(c,"collide",(t=>{4===Ee(t).physics&&(n=2)})),c})();d(n.position,V(-160,160),V(128,32),V(-512,-720)),sn(o,n)}}))),addEventListener("mousedown",(()=>Ge=!0)),addEventListener("mouseup",(()=>Ge=!1)),{ambient:i,directional:r}})(0,so,co),vo=Ye(ro,io,oo),uo=Ye(ro,eo,to),po=$e(ro,vo),ho=no(ro,vo),fo=$e(ro,uo),go=no(ro,uo),bo=ro.createTexture();ro.bindTexture(ro.TEXTURE_2D,bo),ro.texImage2D(ro.TEXTURE_2D,0,ro.RGBA8,1024,1024,0,ro.RGBA,ro.UNSIGNED_BYTE,null),ro.texParameteri(ro.TEXTURE_2D,ro.TEXTURE_MAG_FILTER,ro.NEAREST),ro.texParameteri(ro.TEXTURE_2D,ro.TEXTURE_MIN_FILTER,ro.NEAREST),ro.texParameteri(ro.TEXTURE_2D,ro.TEXTURE_WRAP_S,ro.CLAMP_TO_EDGE),ro.texParameteri(ro.TEXTURE_2D,ro.TEXTURE_WRAP_T,ro.CLAMP_TO_EDGE);const wo=ro.createFramebuffer();ro.bindFramebuffer(ro.FRAMEBUFFER,wo),ro.framebufferTexture2D(ro.FRAMEBUFFER,ro.COLOR_ATTACHMENT0,ro.TEXTURE_2D,bo,0);const zo=ro.createRenderbuffer();ro.bindRenderbuffer(ro.RENDERBUFFER,zo),ro.renderbufferStorage(ro.RENDERBUFFER,ro.DEPTH_COMPONENT16,1024,1024),ro.framebufferRenderbuffer(ro.FRAMEBUFFER,ro.DEPTH_ATTACHMENT,ro.RENDERBUFFER,zo);const Mo=1/60;let Eo,jo=Mo;const Ro=new WeakMap,Oo=(n,t,e,o)=>{const i=Ro.get(e)||{};Ro.set(e,i);const r=i[n]||((n,t)=>{const e=n.createBuffer();return n.bindBuffer(n.ARRAY_BUFFER,e),n.bufferData(n.ARRAY_BUFFER,t,n.STATIC_DRAW),e})(ro,e[n]);i[n]=r,((n,t,e,o)=>{n.bindBuffer(n.ARRAY_BUFFER,e),n.enableVertexAttribArray(t),n.vertexAttribPointer(t,o,n.FLOAT,!1,0,0)})(ro,t,r,o)},Po=new WeakMap,Fo=n=>{const t=Po.get(n)||(n=>{const t=[],e=[];return n.faces.map((o=>{t.push(n.vertices[o.a],n.vertices[o.b],n.vertices[o.c]);const{color:i,vertexColors:r}=o;3===r.length?e.push(...r):e.push(i,i,i)})),{position:l(new Float32Array(3*t.length),t),color:l(new Float32Array(3*e.length),e)}})(n);return Po.set(n,t),t},Ao=m(),To=m(),Co=()=>{dn(so),co.matrixWorldInverse.set(co.matrixWorld),N(co.matrixWorldInverse),ro.useProgram(uo),ro.bindFramebuffer(ro.FRAMEBUFFER,wo),ro.viewport(0,0,1024,1024),ro.clearColor(1,1,1,1),ro.clear(ro.COLOR_BUFFER_BIT|ro.DEPTH_BUFFER_BIT),ro.frontFace(ro.CW),bn(xo.shadow,xo),fn(xo.shadow.camera),mn(so,(n=>{n.visible&&n.geometry&&n.castShadow&&(n=>{const{geometry:t}=n;Qe(ro,go.modelViewMatrix,U(n.modelViewMatrix,xo.shadow.camera.matrixWorldInverse,n.matrixWorld)),Qe(ro,go.projectionMatrix,xo.shadow.camera.projectionMatrix);const e=Fo(t);Oo("position",fo.position,e,3),ro.drawArrays(ro.TRIANGLES,0,e.position.length/3)})(n)})),ro.bindFramebuffer(ro.FRAMEBUFFER,null),ro.useProgram(vo),ro.viewport(0,0,canvas.width,canvas.height),ro.clearColor(0,0,0,0),ro.clear(ro.COLOR_BUFFER_BIT|ro.DEPTH_BUFFER_BIT),ro.frontFace(ro.CCW),Je(ro,ho.ambient,yo),T(To,xo.matrixWorld),T(Ao,xo.target.matrixWorld),((n,t)=>{const{x:e,y:o,z:i}=n;n.x=t[0]*e+t[4]*o+t[8]*i,n.y=t[1]*e+t[5]*o+t[9]*i,n.z=t[2]*e+t[6]*o+t[10]*i,j(n)})(p(To,Ao),co.matrixWorldInverse);const n=g(Object.assign(Ao,xo.color),xo.intensity);Je(ro,ho["directionalLight.direction"],To),Je(ro,ho["directionalLight.color"],n),Qe(ro,ho.directionalShadowMatrix,xo.shadow.matrix),mn(so,(n=>{n.visible&&n.geometry&&n.material&&(n=>{const{geometry:t,material:e}=n;ro.uniform1i(ho.fog,e.fog),Je(ro,ho.fogColor,so.fogColor),ro.uniform1f(ho.fogNear,so.fogNear),ro.uniform1f(ho.fogFar,so.fogFar),Je(ro,ho.diffuse,e.color),Je(ro,ho.specular,e.specular),ro.uniform1f(ho.shininess,e.shininess),Je(ro,ho.emissive,e.emissive),ro.uniform1i(ho.receiveShadow,n.receiveShadow),Qe(ro,ho.modelMatrix,n.matrixWorld),Qe(ro,ho.modelViewMatrix,U(n.modelViewMatrix,co.matrixWorldInverse,n.matrixWorld)),Qe(ro,ho.projectionMatrix,co.projectionMatrix);const o=Fo(t);Oo("position",po.position,o,3),Oo("color",po.color,o,3),ro.drawArrays(ro.TRIANGLES,0,o.position.length/3)})(n)}))},So=()=>{(()=>{const n=.001*(performance.now()||0);Eo||(Eo=n);const t=Math.min(n-Eo,.1);for(jo+=t,Eo=n;jo>=Mo;)mn(so,(n=>{Mn(n,Mo,so)})),jo-=Mo})(),Co(),ao&&requestAnimationFrame(So)},Do=(n,t)=>{canvas.width=n*devicePixelRatio,canvas.height=t*devicePixelRatio,canvas.style.width=n+"px",canvas.style.height=t+"px",ro.viewport(0,0,canvas.width,canvas.height),co.aspect=n/t,vn(co)};Do(innerWidth,innerHeight),So(),addEventListener("resize",(()=>{Do(innerWidth,innerHeight),Co()})),addEventListener("keypress",(n=>{"KeyP"===n.code&&(ao=!ao,ao?So():document.exitPointerLock())})),addEventListener("click",(()=>{ao||(ao=!0,So())}));
